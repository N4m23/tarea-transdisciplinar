<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            margin: 0;
            background: black;
            overflow: hidden;
            touch-action: none;
        }
        canvas {
            touch-action: none;
        }
    </style>
</head>
<body>
    <canvas id="visualizer"></canvas>
    <audio id="audioPlayer"></audio>
    
    <script>
        const audioFiles = [
            'agitacion.mp3',
            'incertidumbre.mp3',
            'atencion.mp3',
            'presencia.mp3',
            'suspension.mp3',
            'desconexion.mp3'
        ];

        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const audioPlayer = document.getElementById('audioPlayer');
        let audioContext, analyser, source, gainNode;
        let currentTrack = 5;
        let isLooping = true;
        let lastPosition = 0;
        let lastTime = 0;
        const VELOCITY_THRESHOLD = 0.8;
        const fadeDuration = 1.5;

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        async function setupAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            gainNode = audioContext.createGain();
            
            audioPlayer.loop = true;
            audioPlayer.src = audioFiles[5];
            audioPlayer.play();
        }

        function transitionTrack(newTrack) {
            gainNode.gain.setValueAtTime(1, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + fadeDuration);
            
            setTimeout(() => {
                audioPlayer.pause();
                isLooping = false;
                currentTrack = newTrack;
                playNewTrack();
            }, fadeDuration * 1000);
        }

        function playNewTrack() {
            audioPlayer.loop = false;
            audioPlayer.src = audioFiles[currentTrack];
            audioPlayer.play();
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + fadeDuration);
            
            audioPlayer.addEventListener('ended', () => {
                if (currentTrack < 4) {
                    currentTrack++;
                    playNewTrack();
                } else {
                    currentTrack = 5;
                    audioPlayer.loop = true;
                    audioPlayer.src = audioFiles[5];
                    audioPlayer.play();
                    isLooping = true;
                }
            }, {once: true});
        }

        function drawVisualization() {
            requestAnimationFrame(drawVisualization);
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 2;
            for(let x = 0; x < canvas.width; x += 40) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            const waveIntensity = dataArray[30] / 255 * 60;
            const baseHeight = canvas.height * 0.4;
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.beginPath();
            ctx.moveTo(0, baseHeight);
            for(let i = 0; i < canvas.width; i++) {
                const y = baseHeight + Math.sin(i * 0.1 + Date.now() * 0.005) * waveIntensity;
                ctx.lineTo(i, y);
            }
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.closePath();
            ctx.fill();
        }

        function handleInput(e) {
            const currentTime = Date.now();
            const currentX = e.clientX || (e.touches[0] ? e.touches[0].clientX : 0);
            
            if (lastPosition !== 0) {
                const velocity = Math.abs(currentX - lastPosition) / (currentTime - lastTime);
                
                if (velocity > VELOCITY_THRESHOLD && isLooping) {
                    transitionTrack(0);
                } else if (isLooping) {
                    transitionTrack(1);
                }
            }
            
            lastPosition = currentX;
            lastTime = currentTime;
        }

        // Event listeners
        canvas.addEventListener('touchstart', handleInput);
        canvas.addEventListener('touchmove', handleInput);
        canvas.addEventListener('touchend', () => lastPosition = 0);
        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('mousemove', (e) => { if(e.buttons === 1) handleInput(e) });
        canvas.addEventListener('mouseup', () => lastPosition = 0);

        window.addEventListener('load', async () => {
            initCanvas();
            await setupAudio();
            drawVisualization();
        });

        window.addEventListener('resize', initCanvas);
    </script>
</body>
</html>
